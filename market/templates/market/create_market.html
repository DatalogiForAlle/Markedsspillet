{% extends "market/base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}{% translate 'Create a new market' %}{% endblock %}

{% block content %}

<h3 class="mt-5">{% translate 'Create a new market' %}</h3>
<h6 class="mb-3">{% translate 'Choose a predefined scenario, or create a market with custom settings.' %}</h6>

<div class="card mb-3">
	<div class="card-header">
		{% translate 'Predefined scenarios'%}
	</div>
	
	<div class="card-body">
		<form id='market_radio_form'>
			<h5 class="card-title">{% translate 'Select scenario' %}<span class="text-muted text" style="font-size:18px"> (view/edit settings below)</span></h5>
			<div class="pl-3 mb-2">
				{% for scenario in scenarios %}
					<input type="radio" id="scenario_{{ forloop.counter0 }}" name="scenario" value="{{ forloop.counter0 }}"
						{% if forloop.counter0 == 0 %}checked{% endif%}>
					<label for="scenario_{{ forloop.counter0 }}" class="mb-0 pb-0">{{ scenario.title }}</label>
					<p class="text-muted p-0 m-0 mb-4" style="font-size:14px">{{ scenario.description }}</p>
				{% endfor %}
			</div>
		</form> 
	</div>
</div>

<div class="card mb-3">
    <div class="card-header" id="headingOne">
      <h5 class="mb-0">
        <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
        	Market Details
        </button>
      </h5>
    </div>

    <div id="collapseOne" class="collapse" aria-labelledby="headingOne">
      <div class="card-body">
      		<form action="" id="create-market-form" method="post">{% csrf_token %}
			{{ form|crispy }}
		</form>
	  </div>
    </div>
</div>

<div class="d-flex justify-content-center">
	<input onclick="submit_form()" value="{% translate "Create" %}" class="btn btn-primary mt-3 mb-4" form="create-market-form">
</div>


{% endblock content %}

{% block javascript %}

<!-- Import scripts shared with market-edit page -->
<script src="{% static "create-update-market-helpers.js" %}"></script>

<script>
	market_form = document.getElementById('create-market-form');
   
	scenarios = {{ scenarios_json|safe }}

	function fill_form(scenario){
		console.log("fill_form")
		// toFixed(2) ensures two decimals on initial rendering of form
		document.getElementById('id_product_name_singular').value=scenario.product_name_singular
		document.getElementById('id_product_name_plural').value=scenario.product_name_plural
		document.getElementById('id_alpha').value=scenario.alpha
		document.getElementById('id_beta').value=scenario.beta
		document.getElementById('id_theta').value=scenario.theta	
		document.getElementById('id_max_rounds').value=scenario.max_rounds
		document.getElementById('id_endless').checked=scenario.endless
		if (scenario.initial_balance == ""){
			// User has chosen the "custom scenario"
			document.getElementById('id_initial_balance').value=scenario.initial_balance; 
			document.getElementById('id_min_cost').value=scenario.min_cost; 
			document.getElementById('id_max_cost').value=scenario.max_cost;
		}
		else{ 
			document.getElementById('id_initial_balance').value=scenario.initial_balance.toFixed(2); 
			document.getElementById('id_min_cost').value=scenario.min_cost.toFixed(2); 
			document.getElementById('id_max_cost').value=scenario.max_cost.toFixed(2);
		}
		adjust_max_round_field()
	}

	/* We should NOT fill out form with predefined scenario values after an unsuccesful post-attempt.
	   Instead, the form will be filled out with the posted values + error messages */
	{% if not form.errors %}fill_form(scenarios[0]){% endif %}
	
	document.getElementById('market_radio_form').addEventListener('change', function() {
		scenario_number = document.querySelector('input[name="scenario"]:checked').value
		scenario = scenarios[scenario_number]
			fill_form(scenario);
		if(scenario_number == 2) {
			// Radio button value changed to 'Custom Scenario'
			// This should make market details section expanded
			document.getElementById('collapseOne').classList.add('show')
		}
		else {
			document.getElementById('collapseOne').classList.remove('show')
		}
	}); 

	document.getElementById('div_id_endless').addEventListener('change', function() {
		adjust_max_round_field()
	});

	adjust_max_round_field()

	function setTwoNumberDecimal(el) {
		// Ensure two decimals after changing form values
        el.value = parseFloat(el.value).toFixed(2);
    };


	{% if form.errors %}
		// If there are errors in the form, the market details should expand, making the errors messages visible. 
		document.getElementById('collapseOne').classList.add('show')
	{% endif %}

</script>


{% endblock javascript %}


