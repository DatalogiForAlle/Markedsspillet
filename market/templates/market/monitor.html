{% extends "market/base.html" %}
{% load i18n %}

{% block title %}{% translate 'Monitor' %}{% endblock %}
{% load custom_tags %}

{% block content %}


<!-- Top colored message -->
{% if market.game_over %}
    <div class="alert alert-info">The game has ended after {{ market.max_rounds }} rounds.</div>
{% endif %}

<!-- Page heading-->
<h2 class="mb-3 mt-lg-5">{{ market.product_name_singular|title }} Market <span class="text-black-50">[{{ market.market_id }}]</span></h2>      

<!-- Buttons -->
<div class="mb-3">
    {% if not market.game_over %}
    <a class="btn btn-primary" data-toggle="collapse" href="#collapseJoin" role="button" aria-expanded="false" aria-controls="collapseJoin">
        Invite players
    </a>
    {% endif %}
    <a class="btn btn-primary ml-3" data-toggle="collapse" href="#collapseDetails" role="button" aria-expanded="false" aria-controls="collapseDetails">
        Market Details
    </a>
</div>


<!-- Join Link Collapse Content-->
<div class="collapse my-1" id="collapseJoin" >
    <div class="card card-body">
        <p class="mb-1">Players can join the market by going to this URL: </p>
        <div class="d-flex">
            <input class="form-control" type="text" 
                value="{% if request.is_secure %}https{% else %}http{% endif %}://{{ request.get_host }}{% url 'market:join_market' %}?market_id={{ market.market_id }}" id="join_link" style="width:350px">
            <button class="btn btn-primary btn-sm" onclick="copy_join_link()">{% translate 'Copy' %}</button>
        </div>
    </div>
</div>

<!-- Market Details Collapse Content-->
<div class="collapse my-1" id="collapseDetails">
    <div class="card card-body">
        <p>
            In this <b>{{ market.product_name_singular}}</b> market, all traders start out with an initial balance of <b>{{ market.initial_balance }}</b> kr. 
            {% if market.min_cost < market.max_cost %}
                When joining the market, the traders are assigned different unit production costs at random, giving some traders an advantage over others. 
                The trader's production costs varies between a minimum of <b>{{ market.min_cost }}</b> kr. and maximum of <b>{{ market.max_cost }}</b> kr. pr unit. 
            {% else %}
                All traders have the same production costs: <b>{{ market.min_cost}}</b> kr. per {{ market.product_name_singular }}, so no traders have a prior advantage over others.
            {% endif %}
            {% if market.endless %}
                The game is <b>endless</b>, so it can go on for an indefinite number of rounds.
            {% else %}
                The game will end after <b>{{ market.max_rounds }}</b> rounds.
            {% endif %} 
            <br><br>
            Should all traders decide to give away their {{ market.product_name_plural}} for free, each trader will experience a demand for 
            <b>{{ market.alpha }}</b> {{ market.product_name_plural }}. 
            When a trader raises her unit price by 1 kr, the demand for her {{ market.product_name_plural }} will 
            decrease by <b>{{ market.beta }}</b>, if the market average price remains unchanged. 
            When the market average goes up by 1 kr, the demand for a trader's product will 
            increase by <b>{{ market.theta }}</b> {{ market.product_name_plural }}, if his unit price remains unchanged.             
            
        </p>
        {% if request.user == market.created_by %}
            <a href="{% url 'market:market_edit' market.market_id %}">{% translate 'Edit details' %}</a> 
        {% endif %}
    </div>
</div>

{% comment %} <a class="btn btn-primary mb-5" href="{% url 'market:market_edit' market.market_id %}">{% translate 'Edit market' %}</a> {% endcomment %}
{% comment %} <h3>{% blocktranslate with round=market.round %}Trader Status Round #{{ round }}{% endblocktranslate %}</h3> {% endcomment %}

<!-- Trader Status -->
<h4 class="mt-5">
    {% if market.game_over %}
    Scoreboard
    {% else %}
    Trader Status
    {% endif %}
    <span class="text-black-50">
        {% if market.game_over %}
            [Game is over]
        {% else %}
            {% if market.endless %}
                [Round {{ market.round|add:1 }}]
            {% else %}
                [Round {{ market.round|add:1 }} / {{ market.max_rounds }}]
            {% endif %}
        {% endif %}
    </span>
</h4> 

<div id="trader_table" class="mb-3">
    {% include 'market/trader-table.html' %}
</div>

{% if not market.game_over %}
    <!-- Next round form and next round pop-up confirmation -->
    <form action="{% url 'market:finish_round' market.market_id %}" method="POST" id="finish_round_form">
            {% csrf_token %}
    </form>
  
    <div class="modal fade" id="nextRoundConfirmationPopUp" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">{% translate 'Confirm next round' %}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% blocktranslate %}
                    Not all traders in your market are ready for next round.
                    <br><br>
                    If you choose to proceed now, these players will enter next round without having traded and with unchanged balance.
                    <br><br>
                    Proceed to next round?
                    {% endblocktranslate %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{% translate 'Cancel' %}</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal"
                        onclick="next_round()">{% translate 'Proceed' %}</button>
                </div>
            </div>
        </div>
    </div>

  
    <!-- Remove trader form and pop-up confirmation -->
    <form action="{% url 'market:remove_trader_from_market' %}" method="POST" id="remove_trader_form">
        {% csrf_token %}
        <input type="hidden" id="remove_trader_id" name="remove_trader_id" value="">
    </form>

    <div class="modal fade" id="removeTraderConfirmationPopUp" tabindex="-1" role="dialog" aria-labelledby="removeTraderModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="removeTraderModalLabel">{% translate 'Remove trader' %}</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="remove-trader-modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{% translate 'Cancel' %}</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal"
                        onclick="document.getElementById('remove_trader_form').submit()">
                        {% translate 'Proceed' %}
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Update trader status table every x seconds. Will only trigger next round when given criteria are met -->
  
    <div 
        hx-get="{% url 'market:trader_table' market.market_id %}"
        hx-trigger="every 1s"
        hx-target="#trader_table">
    </div>

    {% if market.round > 0 %}
        <!-- Autoplay on/off -->

        <div class="d-flex justify-content-center">
            <button id="toggle_auto_finish_btn" class="btn btn-secondary" onclick="toggle_monitor_auto_pilot()" data-toggle="tooltip" 
                {% if market.monitor_auto_pilot %}
                    title="Press this button to pause the auto pilot"> 
                    Pause Game
                {% else %}
                    title="Finish each round automatically when all traders are ready">
                    Start Auto Pilot
                {% endif %}
            </button>
        </div>

        <form action="{% url 'market:toggle_monitor_auto_pilot_setting' market.market_id %}" method="POST" id="toggle_auto_pilot_form">
            {% csrf_token %}
        </form>

        <script>
            // Should round be finished automatically when all traders are ready?
            function toggle_monitor_auto_pilot(){
                document.getElementById('toggle_auto_pilot_form').submit()
            }
        </script>

    {% endif %}
{% endif %}


<div id="accordion" class="mt-5">
    <div class="card">
        <div class="card-header" id="heading_balance">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_balance" aria-expanded="true" aria-controls="collapse_balance">
                    Balance history
                </button>
            </h5>
        </div>
        <div id="collapse_balance" class="collapse show" aria-labelledby="heading_balance">
            <div class="card-body">  
                <div>
                    <canvas id="balanceCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header" id="heading_price">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_price" aria-expanded="true" aria-controls="collapse_price">
                    Price history
                </button>
            </h5>
        </div>
        <div id="collapse_price" class="collapse show" aria-labelledby="heading_price">
            <div class="card-body">
                <div>
                    <canvas id="priceCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
     <div class="card">
        <div class="card-header" id="heading_amount">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_amount" aria-expanded="true" aria-controls="collapse_amount">
                    Production history 
                </button>
            </h5>
        </div>
        <div id="collapse_amount" class="collapse show" aria-labelledby="heading_amount">
            <div class="card-body">
                <div>
                    <canvas id="amountCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<br><br>

{% comment %} 
<h4>Tabular Data</h4>
<div id="accordion">
    {% for field in show_stats_fields %}
    <div class="card">
        <div class="card-header" id="heading_{{ field }}">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_{{ field }}" aria-expanded="true" aria-controls="collapse_{{ field }}">
                {{ field|field_name_to_label }}
                </button>
            </h5>
        </div>
        <div id="collapse_{{ field }}" class="collapse" aria-labelledby="heading_{{ field }}" data-parent="#accordion">
            <div class="card-body">
                {% if traders %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th></th>
                                    {% for round in rounds %}
                                        <th>{{ round }}</th>
                                    {% endfor %}
                                    
                                    <!-- For balances we need an extra column -->
                                    {% if field == 'balance_before' %}
                                        {% if market.game_over %}
                                            <th>Final</th>
                                        {% else %}
                                            <th>{{ market.round|add:1 }}</th>
                                        {% endif %}
                                    {% endif %}
                                </tr>
                            <thead>
                            <tbody>
                                {% for trader in traders %}
                                    <tr>
                                        <!-- queries could be optimized here -->
                                        <td scope="row"> {{trader.name }}</td>
                                        {% for trade in trader.trade_set.all %}
                                            {% if trade.round < market.round %}
                                                <td>{{ trade|get_attribute:field }}</td>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if field == 'balance_before' %}
                                            <td>{{ trader.trade_set.last|get_attribute:'balance_after' }}</td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                        {% else %}
                    <p class="text-muted">No data to show yet.</p>
                {% endif %}
                </div>
                </div>
                </div>
                {% endfor %}
                </div>
                <br><br> {% endcomment %}

                {% comment %} <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-primary mb-5" id="next_round_btn"
                        onclick="alert('Feature not implemented yet, sorry')">
        Download Data
    </button>
</div> {% endcomment %}

{% endblock %}

{% block javascript %}

<script>
    function next_round() {
        document.getElementById("finish_round_form").submit();
    }

    function prepare_remove_trader(trader_id, trader_name){
        document.getElementById('remove_trader_id').value = trader_id;          
        document.getElementById('remove-trader-modal-body').innerHTML = `You are about to permanently remove the trader <b>${trader_name}</b> from the market. Are you sure you want to proceed?` 
        $('#removeTraderConfirmationPopUp').modal('show'); 
    }
</script>

<script>
    function copy_join_link() {
        // From w3schools
        var link_text = document.getElementById("join_link");
        link_text.select();
        link_text.setSelectionRange(0, link_text.value.length);
        document.execCommand("copy")
    }
</script>

<!-- import Chart.js library-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart settings -->
<script>
 
    // Global settings for charts on this page
    Chart.defaults.plugins.title.display = true;
    Chart.defaults.plugins.title.padding = {top:5, bottom:10};
    Chart.defaults.scales.linear.beginAtZero = true; // y axes is forced to include 0
    Chart.defaults.animation.duration = 0; // don't show graph animations
    
    function responsive_aspectRatio(){
        // Set x-axis height relative to y-axis
        if (window.innerWidth < 600){
            return 1.3 
        }
        else{ 
            return 2 
        } 
    } 
        
    function reponsive_display_y_axis_title(){ 
        // Only show y-axis legend on big enough screens 
        if (window.innerWidth < 600) { 
            return false 
            } 
        else{
            return true
        }
    }

    function format_amount_labels(value, index, values){
        // Default format of 5000 on axis is 5,000. 
        // Here we change this to 5000.00
        return value.toFixed(2) 
    }

    // Balance chart 
    balance_labels = JSON.parse("{{ round_labels_json }}") // labels on x-axis
    
    {% if not market.endless %}
        balance_labels.unshift("Start")
    {% endif %}

    var balanceChart = new Chart(document.getElementById('balanceCanvas'), {
        type: 'line',
        data: {
            labels : balance_labels,
            datasets: {{ balanceDataSet|safe }}
        },
        options: {
            aspectRatio: responsive_aspectRatio(),
            scales: {
                y: {
                    title:{ 
                        text: 'Balance (kr.)',
                        display: reponsive_display_y_axis_title()
                    },
                    ticks: {
                        callback: format_amount_labels
                    },
                    suggestedMax: parseInt("{{ market.initial_balance }}"),
                },
                x: {
                    title:{ 
                        text: 'Round',
                        display: true
                    }
                },            
            },  
            plugins: {
                title: {
                    display: false,
                    text: "{% translate 'Balance' %}",
                }
            }
        }     
    });

    // Price chart
    var priceChart = new Chart(document.getElementById('priceCanvas'),{
        type: 'line',
        data: {
            labels: JSON.parse("{{ round_labels_json }}"), // labels on x-axis
            datasets: {{ priceDataSet|safe }}
        },
        options: {
            aspectRatio: responsive_aspectRatio(),
            scales: {
                y: {
                    title:{ 
                        text: 'Unit price (kr.)',
                        display: reponsive_display_y_axis_title()
                    },
                    ticks: {
                        callback: format_amount_labels
                    },
                    suggestedMax: 2*parseInt("{{ market.max_cost }}"),
                },
                x: {
                    title:{
                        text: 'Round',
                        display: true
                    }
                },         
            },  
            plugins: {
                title: {
                    display: false,
                    text: "{% translate 'Unit price' %}",
                }
            }
        }     
    });


    // Amount Chart
    var amountChart = new Chart(document.getElementById('amountCanvas'), {
        type: 'line',
        data: {
            labels: JSON.parse("{{ round_labels_json }}"), // labels on x-axis
            datasets: {{ amountDataSet|safe }}
        },
        options:{
            aspectRatio: responsive_aspectRatio(),
            scales: {
                y: {
                    title:{ 
                        text: 'Number of units',
                        display: reponsive_display_y_axis_title()
                    },
                    suggestedMax: 100,

                },
                x: {
                    title:{ 
                        text: 'Round',
                        display: true
                    }
                },         
            },  
            plugins: {
                title: {
                    display: false,
                    text: "{% translate 'Units produced' %}",
                }
            }
        }
    });
    

</script>

{% endblock %}
