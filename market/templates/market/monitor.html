{% extends "market/base.html" %}
{% block title %}Monitor{% endblock %}
{% block content %}
{% load custom_tags %}

<h2 class="mb-4">
    Monitoring Market: {{ market.market_id }}
</h2>

<p>Players can join using this link:</p>
<input type="text" value="{{ request.get_host }}{% url 'market:join' %}?market_id={{ market.market_id }}" id="join_link" style="width:350px">
<button class="btn btn-primary" onclick="copy_join_link()">Copy</button>

<table class="table table-striped table-responsive mt-4">
    <thead>
        <tr>
            <th>Product name</th>
            <th>Initial balance</th>
            <th>Alpha</th>
            <th>Beta</th>
            <th>Theta</th>
            <th>Min prod.cost</th>
            <th>Max prod.cost</th>
        </tr>
    </thead>
    <tbody>
        <tr>    
            <td>{{ market.product_name_singular }}</td>
            <td>{{ market.initial_balance }}</td>
            <td>{{ market.alpha }}</td>
            <td>{{ market.beta }}</td>
            <td>{{ market.theta }}</td>
            <td>{{ market.min_cost }}</td>
            <td>{{ market.max_cost }}</td>
        </tr>
    </tbody>
</table>
<a class="btn btn-primary mb-5" href="{% url 'market:market_edit' market.market_id %}">Edit Market</a>



<h3>Trader Status Round #{{ market.round }}</h3>

<div 
    hx-get="{% url 'market:trader_table' market.market_id %}"
    hx-trigger="every 2s"
    hx-target="#trader_table">
 </div>

<div id="trader_table" class="mb-5">
    {% include 'market/trader-table.html' %}
</div>

<!-- Pop-up confirmation -->
<div class="modal fade" id="confirmationPopUp" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Confirm Next Round</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Not all traders in your market are ready for next round.
                <br><br>
                If you choose to proceed now, these players will enter next round with unchanged
                balance.
                <br><br>
                Proceed to next round?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal"
                    onclick="next_round()">Proceed</button>
            </div>
        </div>
    </div>
</div>

<div class="mb-5">
  <canvas id="myChart"></canvas>
</div>


{% if market.round > 0 %}
    {% for field in show_stats_fields %}
        <h3>{{ field|field_name_to_label }}</h3>
        {% if field == 'balance_after' %}
            <p>Initial balance: {{ initial_balance }}</p>
        {% endif %}
        <div class="table-responsive mb-5">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th></th>
                        {% for round in rounds %}
						<th scope="col" id="{{field|field_name_to_label}}_{{round}}">Round </th>
                        <script>
						  var col = document.getElementById("{{field|field_name_to_label}}_{{round}}");
						  col.innerHTML += parseInt("{{round}}")+1;
						</script>
                        {% endfor %}
                    </tr>
                <thead>
                <tbody>
                    {% for trader in traders %}
                        <tr>
                            <th scope="row"> {{trader.name }}</th>
                            {% for trade in trader.trade_set.all %}
                              <td>{{ trade|get_attribute:field }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endfor %}

    <button type="button" class="btn btn-primary mb-5" id="next_round_btn" onclick="alert('Feature not implemented yet, sorry')">
        Download data
    </button>
{% endif %}

{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  var roundnums = [0];
  var tradernames = [];
  var balancedata = [];
  var tradernum = 0;
</script>

  {% if market.round > 0 %}
    {% for round in rounds %}
    <script>
   	  roundnums.push(parseInt("{{round}}")+1);
    </script>
    {% endfor %}
    {% for trader in traders %}
	<script>
	  tradernum++;
	  var red = (100 + tradernum*100) % 255;
	  var green = (50 + Math.floor(tradernum/3)*100) % 255;
	  var blue = (0 + Math.floor(tradernum/2)*100) % 255;
	  tradernames.push("{{trader.name}}");
	  balancedata.push({ label: "{{trader.name}}",
						 backgroundColor: 'rgb('+red+','+green+','+blue+')',
						 borderColor: 'rgb('+red+','+green+','+blue+')',
						 data: [parseInt("{{market.initial_balance}}")],
					   });
	</script>
	  {% for trade in trader.trade_set.all %}
      <script>
   	    balancedata[balancedata.length-1].data.push(parseInt("{{trade.balance_after}}"));
      </script>
	  {% endfor %}
    {% endfor %}
  {% endif %}

<script>
  function copy_join_link() {
	  // From w3schools
	  var link_text = document.getElementById("join_link");

	  link_text.select();
	  link_text.setSelectionRange(0, link_text.value.length);

	  document.execCommand("copy");

  }

  const data = {
	  labels: roundnums,
	  datasets: balancedata
  };
  
  const config = {
	  type: 'line',
	  data,
	  options: {}
  };
  var myChart = new Chart(
	  document.getElementById('myChart'),
	  config
  );
</script>


{% endblock %}
