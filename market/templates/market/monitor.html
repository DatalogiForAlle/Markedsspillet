{% extends "market/base.html" %}
{% load i18n %}

{% block title %}{% translate 'Monitor' %}{% endblock %}
{% block content %}
{% load custom_tags %}

<!-- Page heading-->
<h2 class="mb-3 mt-lg-5">{{ market.product_name_singular|title }} Market <span class="text-black-50">[{{ market.market_id }}]</span></h2>      

<!-- Buttons -->
<div class="mb-3">
    {% if not market.game_over %}
    <a class="btn btn-primary" data-toggle="collapse" href="#collapseJoin" role="button" aria-expanded="false" aria-controls="collapseJoin">
        Invite players
    </a>
    {% endif %}
    <a class="btn btn-primary ml-3" data-toggle="collapse" href="#collapseDetails" role="button" aria-expanded="false" aria-controls="collapseDetails">
        Market Details
    </a>
</div>

<!-- Join Link Collapse Content-->
<div class="collapse my-1" id="collapseJoin" >
    <div class="card card-body">
        <p class="mb-1">Players can join the market by going to this URL: </p>
        <div class="d-flex">
            <input class="form-control" type="text" value="{{ request.get_host }}{% url 'market:join' %}?market_id={{ market.market_id }}" id="join_link" style="width:350px">
            <button class="btn btn-primary btn-sm" onclick="copy_join_link()">{% translate 'Copy' %}</button>
        </div>
    </div>
</div>

<!-- Market Details Collapse Content-->
<div class="collapse my-1" id="collapseDetails">
    <div class="card card-body">
        <p>
            In this <b>{{ market.product_name_singular}}</b> market, all traders start out with an initial balance of <b>{{ market.initial_balance }}</b> kr. 
            {% if market.min_cost < market.max_cost %}
                When joining the market, the traders are assigned different unit production costs at random, giving some traders an advantage over others. 
                The trader's production costs varies between a minimum of <b>{{ market.min_cost }}</b> kr. and maximum of <b>{{ market.max_cost }}</b> kr. pr unit. 
            {% else %}
                All traders have the same production costs: <b>{{ market.min_cost}}</b> kr. per {{ market.product_name_singular }}, so no traders have a prior advantage over others.
            {% endif %}
            {% if market.endless %}
                The game is <b>endless</b>, so it can go on for an indefinite number of rounds.
            {% else %}
                The game will end after <b>{{ market.max_rounds }}</b> rounds.
            {% endif %} 
            <br><br>
            The dynamics of the market is controlled by the three parameters α = <b>{{ market.alpha }}</b>, β = <b>{{ market.beta }}</b> and θ = <b>{{ market.theta }}</b>. 
        </p>
        {% if request.user == market.created_by %}
        <a href="{% url 'market:market_edit' market.market_id %}">{% translate 'Edit market' %}</a> 
        {% endif %}
    </div>
</div>

{% comment %} <a class="btn btn-primary mb-5" href="{% url 'market:market_edit' market.market_id %}">{% translate 'Edit market' %}</a> {% endcomment %}
{% comment %} <h3>{% blocktranslate with round=market.round %}Trader Status Round #{{ round }}{% endblocktranslate %}</h3> {% endcomment %}

<!-- Trader Status -->
<h4 class="mt-5">
    {% if market.game_over %}
    Scoreboard
    {% else %}
    Trader Status
    {% endif %}
    <span class="text-black-50">
        {% if market.game_over %}
            [Game Over]
        {% else %}
            {% if market.endless %}
                [Round {{ market.round|add:1 }}]
            {% else %}
                [Round {{ market.round|add:1 }} / {{ market.max_rounds }}]
            {% endif %}
        {% endif %}
    </span>
</h4> 

<div id="trader_table" class="mb-5">
    {% include 'market/trader-table.html' %}
</div>

{% if not market.game_over %}
<!-- Update trader status table every x seconds -->
<div 
    hx-get="{% url 'market:trader_table' market.market_id %}"
    hx-trigger="every 2s"
    hx-target="#trader_table">
</div>
{% endif %}

<!-- Pop-up confirmation -->
<div class="modal fade" id="confirmationPopUp" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">{% translate 'Confirm next round' %}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {% blocktranslate %}
                Not all traders in your market are ready for next round.
                <br><br>
                If you choose to proceed now, these players will enter next round with unchanged balance.
                <br><br>
                Proceed to next round?
                {% endblocktranslate %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{% translate 'Cancel' %}</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal"
                    onclick="next_round()">{% translate 'Proceed' %}</button>
            </div>
        </div>
    </div>
</div>

<h4>Graphs</h4>
<div id="accordion">
    <div class="card">
        <div class="card-header" id="heading_balance">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_balance" aria-expanded="true" aria-controls="collapse_balance">
                    Balance
                </button>
            </h5>
        </div>
        <div id="collapse_balance" class="collapse" aria-labelledby="heading_balance" data-parent="#accordion">
            <div class="card-body">  
                <div class="mb-5">
                    {% if traders %}
                        <canvas id="balanceCanvas"></canvas>
                    {% else %}
                        <div class="text-muted">No data to show yet.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-header" id="heading_price">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_price" aria-expanded="true" aria-controls="collapse_price">
                    Price 
                </button>
            </h5>
        </div>
        <div id="collapse_price" class="collapse" aria-labelledby="heading_price" data-parent="#accordion">
            <div class="card-body">
                <div class="mb-5">
                    {% if traders %}
                    <canvas id="priceCanvas"></canvas>
                    {% else %}
                        <div class="text-muted">No data to show yet.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
     <div class="card">
        <div class="card-header" id="heading_amount">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_amount" aria-expanded="true" aria-controls="collapse_amount">
                    Production 
                </button>
            </h5>
        </div>
        <div id="collapse_amount" class="collapse" aria-labelledby="heading_amount" data-parent="#accordion">
            <div class="card-body">
                <div class="mb-5">
                    {% if traders %}
                    <canvas id="amountCanvas"></canvas>
                    {% else %}
                        <div class="text-muted">No data to show yet.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
<br><br>


<h4>Tabular Data</h4>
<div id="accordion">
    {% for field in show_stats_fields %}
    <div class="card">
        <div class="card-header" id="heading_{{ field }}">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapse_{{ field }}" aria-expanded="true" aria-controls="collapse_{{ field }}">
                {{ field|field_name_to_label }}
                </button>
            </h5>
        </div>
        <div id="collapse_{{ field }}" class="collapse" aria-labelledby="heading_{{ field }}" data-parent="#accordion">
            <div class="card-body">
                {% if traders %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th></th>
                                    {% for round in rounds %}
                                        <th>{{ round }}</th>
                                    {% endfor %}
                                    
                                    <!-- For balances we need an extra column -->
                                    {% if field == 'balance_before' %}
                                        {% if market.game_over %}
                                            <th>Final</th>
                                        {% else %}
                                            <th>{{ market.round|add:1 }}</th>
                                        {% endif %}
                                    {% endif %}
                                </tr>
                            <thead>
                            <tbody>
                                {% for trader in traders %}
                                    <tr>
                                        <!-- queries could be optimized here -->
                                        <td scope="row"> {{trader.name }}</td>
                                        {% for trade in trader.trade_set.all %}
                                            {% if trade.round < market.round %}
                                                <td>{{ trade|get_attribute:field }}</td>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        {% if field == 'balance_before' %}
                                            <td>{{ trader.trade_set.last|get_attribute:'balance_after' }}</td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No data to show yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<br><br>

{% comment %} <div class="d-flex justify-content-center">
    <button type="button" class="btn btn-primary mb-5" id="next_round_btn" onclick="alert('Feature not implemented yet, sorry')">
        Download Data
    </button>
</div> {% endcomment %}

{% endblock %}

{% block javascript %}


<script>
    function copy_join_link() {
        // From w3schools
        var link_text = document.getElementById("join_link");
        link_text.select();
        link_text.setSelectionRange(0, link_text.value.length);
        document.execCommand("copy")
    }
</script>

<!-- import Chart.js library-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    {% if traders %}

    const balanceData = {
        labels: JSON.parse("{{ round_labels_json }}"), // labels on x-axis
        datasets: {{ balanceDataSet|safe }}
    }; 
    balanceData.labels.push("Final")

    const priceData = {
        labels: JSON.parse("{{ round_labels_json }}"), // labels on x-axis
        datasets: {{ priceDataSet|safe }}
    };
  
    const amountData = {
        labels: JSON.parse("{{ round_labels_json }}"), // labels on x-axis
        datasets: {{ amountDataSet|safe }}
    };
    const configBalance = {
        type: 'line',
        data: balanceData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }        
            },  
            plugins: {
                title: {
                    display: true,
                    text: "{% translate 'Balance each round' %}",
                    padding: {
                        top: 5,
                        bottom: 10
                    }
                }
            }
        }     
    }
    const configPrice = {
        type: 'line',
        data: priceData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }         
            },  
            plugins: {
                title: {
                    display: true,
                    text: "{% translate 'Unit price in each round' %}",
                    padding: {
                        top: 5,
                        bottom: 10
                    }
                }
            }
        }     
    }

    const configAmount = {
        type: 'line',
        data: amountData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }         
            },  
            plugins: {
                title: {
                    display: true,
                    text: "{% translate 'Units produced in each round' %}",
                    padding: {
                        top: 5,
                        bottom: 10
                    }
                }
            }
        }     
    }
    balanceCanvas = document.getElementById('balanceCanvas')
    priceCanvas = document.getElementById('priceCanvas')
    amountCanvas = document.getElementById('amountCanvas')

    var myChart = new Chart(
        balanceCanvas,
        configBalance
    );

    var myChart = new Chart(
        priceCanvas,
        configPrice
    );

    var myChart = new Chart(
        amountCanvas,
        configAmount
    );


</script>
{% endif %}

{% endblock %}
