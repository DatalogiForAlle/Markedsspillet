{% extends "market/base.html" %}
{% load crispy_forms_tags %}
{% load custom_tags %}

{% block title %}Play{% endblock %}

{% block content %}

{% if wait %}
<div style="border:1px solid red" class="p-5 mb-5">
    
    <p> Thanks for making a trade!</p>
    <h3>Waiting for market host to finish round #{{ market.round }} ...</h3>
    </p>
    <p></p>

</div>
{% endif %}

<!-- Info on trader and current status -->
<div class="row mb-5">
    <div class="col-12 col-md-6">    
        <div class="card">
            <div class="card-header">
                Trader
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">Name: <b>{{ trader.name }}</b></li>
                    <li class="list-group-item">Market: <b>{{ market.market_id }}</b></li> 
                    <li class="list-group-item">Production costs per unit: <b>{{ trader.prod_cost }}</b></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6">
        <div class="card">
            <div class="card-header">
                Financial Status (Round #{{ market.round }})
            </div>
            <div class="card-body">
            
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">Initial balance: <b>{{ initial_balance }}</b></li>
                    <li class="list-group-item">Current balance: <b>{{ trader.balance }}</b></li>
                    <li class="list-group-item">Net gain (all rounds): <b
                            style="color:{{ total_gain_color }}">{{ trader.balance|subtract:initial_balance}}</b></li>
                </ul>
            </div>
        </div>
    </div>    
</div>

{% if show_last_round_data %}
<!-- Results from last round -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                Data from last round (Round #{{ market.round | subtract:1 }})
            </div>
            <div class="card-body">
                <ul>
                    <li>Your unit price last round was {{ trades.last.unit_price }}</li>
                    <li>The market average unit price last round was
                        {{ round_stats.all.last.avg_price | floatformat:1 }}</li>
                    <li>You produced {{ trades.last.unit_amount}} units</li>
                    <li>You sold produced {{ trades.last.units_sold }} units</li>
                    <li>Your profit last round was: <span style="color:{{last_round_gain_color}}">
                            {{ trades.last.profit }}</span></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}


{% if market.round > 0 %}
<!-- Trade history  -->
<div class="row mb-5">
    <div class="col">
        <div class="card">
            <div class="card-header">
                Trade History
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th></th>
                                {% for round in rounds %}
                                    <th scope="col">Round {{ round }}</th>
                                {% endfor %}
                                {% if wait %}
                                    <th scope="col">Round {{ market.round }}</th>
                                {% endif %}

                            </tr>
                            <thead>
                            <tbody>
                                <tr>
                                    <td scope="row">Units Produced</td>
                                    {% for trade in trades %}
                                        <td>{{ trade|get_attribute:'unit_amount' }}</td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td scope="row">Units Sold</td>
                                    {% for trade in trades %}
                                    <td>{{ trade|get_attribute:'units_sold' }}</td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td scope="row">Unit Price</td>
                                    {% for trade in trades %}
                                    <td>{{ trade|get_attribute:'unit_price' }}</td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td scope="row">Market Avg. Price</td>
                                    {% for round_stat in round_stats %}
                                    <td>{{ round_stat.avg_price | floatformat:0 }}</td>
                                    {% endfor %}
                                    {% if wait %}
                                        <td scope="col"> ---- </td>
                                    {% endif %}
                                </tr>
                                <tr>
                                    <td scope="row">Profit</td>
                                    {% for trade in trades %}
                                    <td>{{ trade|get_attribute:'profit' }}</td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td scope="row">Balance (Initial: {{ initial_balance }})</td>
                                    {% for trade in trades %}
                                    <td>{{ trade|get_attribute:'balance_after' }}</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if not wait %}
<!-- Next Trade -->
<div class="row mb-5">
    <div class="col">
        <div class="card">
            <div class="card-header mb-2">
                Make Your Next Trade
            </div>
            <div class="card-body">
                {% if market.round > 0 %}
                <p class="text-secondary mb-4">
                    {% if show_last_round_data %}
                    
                    Last round you produced {{ trades.last.unit_amount }} unit and sold {{ trades.last.units_sold }} units.<br>
                    Your unit price last round was: {{ trades.last.unit_price }}.<br>
                    {% endif %}
                    Market average unit price last round: {{ round_stats.all.last.avg_price | floatformat:1 }}.
                </p>
                {% endif %}
                <form action="{% url 'market:play' %}" method="post" class="mb-4" id='trade_form'>{% csrf_token %}
                    {{ form|crispy }}
                </form>
                <ul class="text-secondary">
                    <li>Total production cost: <span id="total_prod_cost"></span> (can't exceed you current balance of
                        {{ trader.balance }}) </li>
                    <li>Potential income (best case - all units sold): <span id="potential_income"></span></li>
                    <li>Net gain (best case - all units sold): <span style="color:blue" id="net_gain_best_case"></span>
                    </li>
                    <li>Net gain (worst case - no units sold): <span style="color:blue" id="net_gain_worst_case"></span>
                    </li>
                </ul>
                <div class="d-flex justify-content-center">
                    <input type="submit" value="Make Trade!" class="btn btn-outline-primary" form="trade_form">
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block javascript %}

{%if not wait %}
<script>
    
    var labels = document.getElementsByTagName('label');    
    var price_label = labels[0]
    var amount_label = labels[1]
    
    var amount_slider = document.getElementById("id_unit_amount");
    var price_slider = document.getElementById("id_unit_price");

    var unit_prod_cost = parseInt("{{ trader.prod_cost }}")
    var total_cost = document.getElementById('total_cost');
    var potential_income = document.getElementById('potential_income');
    var net_gain_best_case = document.getElementById('net_gain_best_case')
    var net_gain_worst_case = document.getElementById('net_gain_worst_case')
    
    function set_price_label(){
        price_label.innerHTML = "Unit Price: " + price_slider.value; 
    }
    
    function set_amount_label(){
        amount_label.innerHTML = "Amount: " + amount_slider.value;
    }

    function set_total_cost(){
        amount = amount_slider.value;
        total_prod_cost.innerHTML = `${amount}*${unit_prod_cost} = ${amount * unit_prod_cost}`;
    }

    function set_potential_income(){
        amount = amount_slider.value;
        price = price_slider.value;
        potential_income.innerHTML = `${amount}*${price} = ${amount * price}`;
    }
    
 
    function set_potential_net_gain(){
        amount = amount_slider.value;
        price = price_slider.value;
        
        expences = amount*unit_prod_cost;
        best_case = amount*price - expences
        worst_case = - expences

        if (best_case < 0){
            net_gain_best_case.style.color = 'red'
        } else{
            net_gain_best_case.style.color = 'blue'
        }

        if (worst_case < 0){
            net_gain_worst_case.style.color='red'
        } else{
        net_gain_worst_case.style.color = 'blue'
        }

        net_gain_best_case.innerHTML = best_case;
        net_gain_worst_case.innerHTML = worst_case;
    }

    set_price_label();
    set_amount_label();
    set_total_cost(); 
    set_potential_income()
    set_potential_net_gain()

    //slider max 

    price_slider.oninput = function () {
        set_price_label();
        set_potential_income();
        set_potential_net_gain();
    }

    amount_slider.oninput = function () {
        set_amount_label();
        set_total_cost();
        set_potential_income();
        set_potential_net_gain();
    }
    
</script>
{% endif %}

<script>
    round_num = parseInt("{{ market.round }}");
    market_id = "{{ market.market_id }}";
    function check_for_next_round() {
        $.ajax({
            type: 'GET',
            url: "{% url 'market:current_round' market.market_id %}",
            data: {
                    'market_id': market_id
            },
            dataType: 'json',
            success: function (data) {
                console.log(data, data.round, round_num);
                if (data.round > round_num) {
                    window.location.href = "{% url 'market:play' %}"
                }
            }
        });
    }

    window.setInterval(check_for_next_round, 1000);
</script>

{% endblock %}
