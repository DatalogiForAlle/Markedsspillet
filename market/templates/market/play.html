{% extends "market/base.html" %}
{% load crispy_forms_tags %}
{% load custom_tags %}
{% load static%}
{% load i18n %}

{% block title %}{% translate 'Play' %}{% endblock %}
{% block content %}
    <!-- Top colored message -->
    {% if wait %}
        <div class="alert alert-success">You made a trade!</div>
    {% else %} 
        {% if market.game_over %}
            <div class="alert alert-info">The game has ended after {{ market.max_rounds }} rounds.</div>
        {% else %}
            {% if market.round == trader.round_joined %}
                <!-- a verbose & enthusiastic message welcoming new traders -->
                {% if market.endless %}
                    <div class="alert alert-success">Hi {{ trader.name }}! You are now ready for round {{ market.round|add:1 }} on the {{ market.product_name_singular }} market {{ market.market_id }}.</div>
                {% else %}
                    <div class="alert alert-success">Hi {{ trader.name }}! You are now ready for round {{ market.round|add:1 }} out of {{ market.max_rounds }} on the {{ market.product_name_singular }} market {{ market.market_id }}.</div>
                {% endif %}                
            {% else %}
                <!-- a less verbose and less enthusiastic message for other traders -->
                {% if market.endless %}
                    <div class="alert alert-success">Your are now ready for round {{ market.round|add:1 }}.</div>
                {% else %}
                    <div class="alert alert-success">Your are now ready for round {{ market.round|add:1 }} out of {{ market.max_rounds }}.</div>
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}   

<div class="row mt-lg-4" >    
    <div class="col-12 col-lg-6">

        <!-- Paragraph with info about what just happened and current status -->
        <p class="pr-2 pl-2 py-3 alert alert-warning"> 
            {% if not wait %}
                
                {% if market.round == trader.round_joined  %}
                    Your fixed production cost pr. unit is <b>{{ trader.prod_cost }}</b> kr. <br>
                    <!-- Oversæt til: "Dine faste produktionsomkostninger er xx kr. -->
                {% elif not trades.last.was_forced %}
                    <!-- Text with info about last round choices and results.  -->
                    {% blocktranslate with name=trader.name lastRoundUnits=trades.last.unit_amount lastRoundSold=trades.last.units_sold unitsPlural=market.product_name_plural lastRoundDemand=trades.last.demand lastRoundPrice=trades.last.unit_price lastRoundAvgPrice=round_stats.all.last.avg_price %}
                        Hi {{ name }}. <br class="hide-when-small"> Last round you produced <b>{{ lastRoundUnits }}</b> and sold
                        <b>{{ lastRoundSold }}</b>
                        {{ unitsPlural }}. The demand was <b>{{ lastRoundDemand }}</b> baguettes. Your price was
                        <b>{{ lastRoundPrice }} </b>kr. and the market
                        average price was <b>{{ lastRoundAvgPrice }}</b> kr.
                    {% endblocktranslate %}
                        Your profit was
                    {% if trades.last.profit < 0 %}<b style="color:red">
                    {% else %} <b style="color:green">
                    {% endif %}{{ trades.last.profit }}</b> kr.
                {% endif %}
                
                {% if trades.last.was_forced and trader.round_joined < market.round %}
                    {% translate "You didn't make a trade last round." %} 
                {% endif %}
            
            {% else %} 
                <!-- wait is true -->
                Hi {{ trader.name }}.<br class="hide-when-small"> You decided to produce <b>{{ trades.last.unit_amount }}</b>  
                {{ market.product_name_plural }} and to sell them for <b>{{  trades.last.unit_price }}</b> kr. each</b>. 
                {% comment %} 
                Suggested translation:
                Du valgte at producere <b>{{ trades.last.unit_amount }}</b>  
                {{ market.product_name_plural }}, som du vil sælge for <b>{{  trades.last.unit_price }}</b> kr. pr. styk.</b>.  
                {% endcomment %}
                {% blocktranslate with balance=trader.balance %}
                    Your current balance is <b style="color:green">{{ balance }}</b> kr.
                {% endblocktranslate %}                 
                <i>Now wait for the host to finish round {{ market.round|add:1 }}.</i>
            {% endif %}

            {% if not wait %}
                {% blocktranslate with balance=trader.balance %}
                    Your current balance is <b style="color:green">{{ balance }}</b> kr.
                {% endblocktranslate %}             
            {% endif %}
        </p>

        {% if not wait and not market.game_over %}
            <!-- Next trade form -->
            <div class="card mb-3">
                <div class="card-header">
                {% translate 'Make your next trade' %}
                </div>
                <div class="card-body pb-2">
                    <form action="{% url 'market:play' market.market_id %}" method="post" class="mb-4" id='trade_form'>
                        {% csrf_token %}
                        {{ form|crispy }}
                    </form>
                    <div class="d-flex justify-content-center mt-4 mb-4">
                        <input type="submit" value="{% translate 'Make Trade!' %}" class="btn btn-outline-primary" form="trade_form">
                    </div>

                    <div class="d-flex justify-content-center">
                        <ul class="text-secondary">
                            <li>
                                {% translate 'Total prod. cost' %}: <span id="total_prod_cost_formula"></span><b id="total_prod_cost"></b> kr.
                            </li>
                            <li>
                                {% translate 'Balance after production' %}: <span id="balance_after_production_formula"></span><b id="balance_after_production"></b> kr.
                            </li>
                            <li>
                                {% translate 'Income if all units are sold' %}: <span id="income_best_case_formula"></span><b id="income_best_case"></b> kr.
                            </li>
                            <li>
                                {% translate 'Profit if all units are sold' %}: <span id="profit_best_case_formula"></span> <b id="profit_best_case"></b> kr. 
                            </li>
                            <li>{% translate 'Profit if no units are sold' %}: <span id="profit_worst_case_formula"></span><b id="profit_worst_case"></b> kr.
                            </li>
                        </ul>        
                    </div>
                </div>

            </div>

{% if market.allow_robots %}
            <div class="card mb-3 p-3 pb-0">
                <h3>Trade algorithm</h3>
                <p>Use Python to automate your trade decisions!</p>
                <textarea id="code_before" class="bg-light" readonly class="w-100" rows="6">
"""
Below we define some useful constants that you can use in your script. The value of these constants will change from round to round.
""" 
# your current balance
balance = {{ trader.balance|to_float }}

# your production cost pr. unit (fixed)
prod_cost = {{ trader.prod_cost|to_float }}

# the maximal number of {{ market.product_name_plural }} you can afford to produce
max_amount = {{ max_amount }}

# the maximal price pr. {{ market.product_name_singular }} you can choose (fixed)
max_price = {{ max_price|to_float }}

# current round
round = {{ market.round|add:1 }}

# market average price last round (will be None in first round)
{% if market.round > 0 %}
avg_price = {{ round_stats.all.last.avg_price|to_float }}
{% else %}
avg_price = None
{% endif %}

# demand for your baguettes last round (will be None in first round)
{% if market.round > 0 %}
demand_last_round = {{ trades.last.demand }}
{% else %}
demand_last_round = None
{% endif %}
</textarea>
<p class="mt-3">Your code goes here:</p>
<textarea id="client_code" class="w-100" rows="7">
import random

# price for one {{ market.product_name_singular }}
price_choice = random.uniform(0, max_price)

# number of {{ market.product_name_plural }}  to produce 
amount_choice = random.randint(0, max_amount)</textarea>
<div class="d-flex justify-content-between p-3 pb-0">
    <button class="btn btn-outline-primary" type="button" onclick="runit(submit=false)">Test output</button> 

    <button class="btn btn-outline-warning" type="button" onclick="runit(submit=true)">Make Single Trade</button> 

    <button class="btn btn-outline-danger" type="button" onclick="runit(submit=true, auto_play=true)">Autoplay entire game</button> 
</div>
<textarea id="code_after" class="bg-light p-0 m-0" cols="40" rows="10" style="visibility:hidden; display:none;" readonly>#
print("")
print("Your algorithm produced these raw values:")
try:
    price_choice
    print("Price:", price_choice)
except:
    print("Price: Not defined in your script!")

try:
    amount_choice
    print("Amount: ", amount_choice)
except:
    print("Amount: Not defined in your script!")</textarea>

                    
            <pre id="output">
                <!-- Python print statements in text-area will have output here-->
            </pre> 
            <div id="cleaned_values"></div>                   
            </div> <!-- end of algoritm card-->
            
           

        {% endif %}<!-- end of 'if market.allow_robots' -->

{% endif %} 

        {% if market.game_over %}
            <!-- ScoreBoard -->
            <table class="table table-sm" >
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">{% translate 'Name' %}</th>
                        <th scope="col">{% translate 'Final balance' %}</th>
                    </tr>
                </thead>

                <div class="mb-5">
                    {% for trader in traders %}
                        {% if request.session.username == trader.name %}
                        <tr style="background-color:rgb(75,192,192,0.1)">
                            <td scope="row">{{ forloop.counter }}</td>
                            <td>You</td>
                            <td>{{ trader.balance }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td scope="row">{{ forloop.counter }}</td>
                            <td>{{ trader.name }}</td>
                            <td>{{ trader.balance }}</td>
                        </tr> 
                        {% endif %}
                    {% endfor %}
                </div>
            </table>
        {% endif%}
    </div><!-- end of column -->

    <!-- Scoreboards and charts -->
    <div class="col-12 col-lg-6 mt-3 mt-lg-0 ">
      
        <!-- Price chart-->
        <canvas class="mt-2 mb-0 mb-lg-4" id="priceCanvas">
        </canvas>
        
        <!-- Units chart-->
        <canvas class="mt-2 mb-4" id="unitsCanvas"></canvas>
    
       <!-- Balance chart-->
        <canvas class="mt-2 mb-4" id="balanceCanvas"></canvas>
    </div>
</div>
{% endblock content %}

{% block javascript %}

<script>
// Display currency amount with 2 decimals
function prettify (num) {
    return num.toFixed(2);
}
</script>

{% if not wait %}
<script>
    var labels = document.getElementsByTagName('label');    
    var price_label = labels[0]
    var amount_label = labels[1]
    
    var amount_slider = document.getElementById("id_unit_amount");
    var price_slider = document.getElementById("id_unit_price");
    var balance = parseFloat("{{ trader.balance }}".replace(',', '.'))
    var unit_prod_cost = parseFloat("{{ trader.prod_cost }}".replace(',', '.'))
    var total_cost = document.getElementById('total_cost');
    var income_best_case = document.getElementById('income_best_case');
    var balance_after_production = document.getElementById('balance_after_production');
    var profit_best_case = document.getElementById('profit_best_case')
    var profit_worst_case = document.getElementById('profit_worst_case')
    var market_max_cost = parseFloat("{{ trader.market.max_cost }}".replace(',', '.'));
    var market_average_price = parseFloat("{{ round_stats.all.last.avg_price }}".replace(',', '.'));
    var round = "{{ trader.market.round }}";

    // only show calculations when screen width is bigger than this number
    const show_formula_breakpoint = 490;

    function initializeRangeSliders() {
        var $priceslider = $(".price-slider");
        var $productionslider = $(".production-slider");

        // Custom Marks using code from http://ionden.com/a/plugins/ion.rangeSlider/showcase.html#a_marks
        var min = $priceslider.attr("min");
        var max = $priceslider.attr("max");
        function convertToPercent (num) {
	    var percent = ((num - min) / (max - min)) * 100;
	    return percent;
        }

        function addMark ($slider, value, description) {
            var left = convertToPercent(value);
            var html = '<span class="slider_mark" style="left: ' + left + '%"> '
                       + value
                       + ' kr. (' + description + ')</span>';
            $slider.append(html);
        }

        $priceslider.ionRangeSlider({
          skin: "round",
          type: "single",
          grid : true,
          min: min,
          max: max,
          hide_min_max : true,
          step: 0.1,
          from: unit_prod_cost,
          prettify : prettify ,
          postfix : " kr.",
          onStart: function (data) {
              addMark(data.slider, unit_prod_cost, "din produktionspris");
              if (round > 0) {
    	          addMark(data.slider, market_average_price, "markedsgennemsnit.");
              }
          }
        });

        $productionslider.ionRangeSlider({
          skin: "round",
          type: "single",
          grid : true,
          min: $productionslider.attr("min"),
          max: $productionslider.attr("max"),
          hide_min_max : true,
          step: 1,
          from: 0,
          postfix : " stk."
        });
    }

    function set_total_cost(){
        amount = amount_slider.value; 
        total_prod_cost.innerHTML = prettify(amount * unit_prod_cost);
        if ($(window).width() > show_formula_breakpoint) {
            formula = document.getElementById('total_prod_cost_formula')
            formula.innerHTML = `${amount} * ${prettify(unit_prod_cost)} = `;
        } 
    }
    
    function set_potential_income(){
        amount = amount_slider.value;
        price = parseFloat(price_slider.value);
        income_best_case.innerHTML = prettify(amount*price);
        
        if ($(window).width() > show_formula_breakpoint) { 
            formula = document.getElementById('income_best_case_formula')
            formula.innerHTML = `${amount} * ${prettify(price)} = `; 
        }
    }

    function set_balance_after_production(){
        amount = amount_slider.value;
        costs = amount * unit_prod_cost;
        balance_after_production.innerHTML = prettify(balance - costs);

        if ($(window).width() > show_formula_breakpoint) { 
            formula = document.getElementById('balance_after_production_formula')
            formula.innerHTML = `${prettify(balance)} - ${prettify(costs)} = `;
        } 
    }
 
    function set_potential_profit(){
        amount = amount_slider.value;
        price = price_slider.value;
        expences = amount*unit_prod_cost;
        best_case_income = amount*price;
        best_case_profit = best_case_income - expences
        worst_case_profit = - expences

        if (best_case_profit < 0){
            profit_best_case.style.color = 'red'
        } else{
            profit_best_case.style.color = 'green'
        }
        
        if (worst_case_profit < 0){
            profit_worst_case.style.color='red'
        } else{
            profit_worst_case.style.color = 'green'
        }
        profit_best_case.innerHTML = prettify(best_case_profit);
        profit_worst_case.innerHTML = prettify(-expences);

        if ($(window).width() > show_formula_breakpoint) { 
            document.getElementById('profit_best_case_formula').innerHTML = `${prettify(best_case_income)} - ${prettify(expences)} = `;
            document.getElementById('profit_worst_case_formula').innerHTML = `0.00 - ${prettify(expences)} = `;
        }     
    }

    initializeRangeSliders();
    set_total_cost(); 
    set_potential_income()
    set_balance_after_production()
    set_potential_profit()

    price_slider.oninput = function () {
        set_potential_income();
        set_balance_after_production()
        set_potential_profit();
    }

    amount_slider.oninput = function () {
        set_total_cost();
        set_potential_income();
        set_balance_after_production()
        set_potential_profit();
    }
    
</script>
{% endif %}

{% if market.allow_robots %}
<script type="text/javascript"> 
    // output functions are configurable.  This one just appends some text
    // to a pre element.
    function outf(text) { 
        var mypre = document.getElementById("output"); 
        mypre.innerHTML = mypre.innerHTML + text; 
    } 
    function builtinRead(x) {
        if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                throw "File not found: '" + x + "'";
        return Sk.builtinFiles["files"][x];
    }

    // Here's everything you need to run a python program in skulpt
    // grab the code from your textarea
    // get a reference to your pre element for output
    // configure the output function
    // call Sk.importMainWithBody()
    function runit(submit=false, auto_play=false) { 
        document.getElementById("cleaned_values").innerHTML = ""
        var code_before = document.getElementById("code_before").value;         
        var client_code = document.getElementById("client_code").value; 
        var code_after = document.getElementById("code_after").value;         
        prog = code_before + client_code + code_after

        var mypre = document.getElementById("output"); 
        mypre.innerHTML = ''; 
        Sk.pre = "output";
        Sk.configure({output:outf, read:builtinRead}); 
        var myPromise = Sk.misceval.asyncToPromise(function() {
            return Sk.importMainWithBody("<stdin>", false, prog, true);
        });
        myPromise.then(
            function(mod) {
                console.log('Skulpt: Python code parsed successfully');
                max_amount = Sk.ffi.remapToJs(Sk.globals["max_amount"])
                max_price = Sk.ffi.remapToJs(Sk.globals["max_price"])               
        
                // clean price_choice
                price_choice = Sk.ffi.remapToJs(Sk.globals["price_choice"])
                console.log("Input price_choice =", price_choice)
                if (!price_choice){
                    price_choice = 0
                    console.log("price_choice not defined ... set to 0")
                    //mypre.innerHTML += "price_choice not defined in your script. Price will be set to 0"
               }
                if(price_choice < 0){
                    price_choice = 0
                    console.log("price_choice negative ... set to 0")
                }
                if(price_choice > max_price ){
                    price_choice = max_price
                    console.log("price_choice bigger than max_price ... set to max_price")
                }
                if(!(typeof price_choice == 'number')){
                    price_choice = 0
                    console.log("price_choice not a number ... set to zero")
                }
                price_choice = price_choice.toFixed(2)
                console.log("Cleaned price_choise = ", price_choice)
                
                // clean amount_choice
                amount_choice = Sk.ffi.remapToJs(Sk.globals["amount_choice"])
                console.log("Input amount_choice =", amount_choice)
                if (!amount_choice){
                    amount_choice = 0
                    console.log(`amount_choice not defined... set to 0`)
               }
                if(amount_choice < 0){
                    amount_choice = 0
                    console.log("amount_choice negative ... set to 0")
                }
                if(amount_choice > max_amount ){
                    amount_choice = max_amount
                    console.log("amount_choice bigger than max_price ... set to max_amount")
                }
                if(!(typeof amount_choice == 'number')){
                    amount_choice = 0
                    console.log("amount_choice not a number ... set to zero")
                }
                amount_choice = Math.round(amount_choice);
                console.log("Cleaned amount_choise = ", amount_choice)
                
                if (auto_play){
                    document.getElementById("id_auto_play").value = true
                }
                if (submit){     
                    var amount_slider = document.getElementById("id_unit_amount");
                    var price_slider = document.getElementById("id_unit_price");
                    amount_slider.value = amount_choice
                    price_slider.value = price_choice
                    document.getElementById('trade_form').submit()
                }
                else{
                    mypre.innerHTML += `<br>Your algorithm would have resulted in these valid choices:<br>Price pr {{ market.product_name_singular }}: ${price_choice} kr.<br>Number of {{ market.product_name_plural }}: ${amount_choice}</li></ul>`
                }
            },
            function(err) {
                console.log("Python error: " + err.toString());
                mypre.innerHTML += err.toString()
        });
    } 
   
    </script> 

    <!-- Skulpt -->
    <script src="{% static "skulpt/skulpt.min.js" %}"></script>
    <script src="{% static "skulpt/skulpt-stdlib.js" %}"></script>
{% endif %}

<script>
    round_num = parseInt("{{ market.round }}");
    market_id = "{{ market.market_id }}";
    function check_for_next_round() {
        $.ajax({
            type: 'GET',
            url: "{% url 'market:current_round' market.market_id %}",
            data: {
                    'market_id': market_id
            },
            dataType: 'json',
            success: function (data) {
                if (data.round > round_num) {
                    window.location.href = "{% url 'market:play' market.market_id %}"
                }
            }
        });
    }
    window.setInterval(check_for_next_round, 1000);
</script>


<!-- import Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart settings -->
<script>

    // Global settings for charts on this page
    Chart.defaults.plugins.title.display = false;
    Chart.defaults.plugins.title.padding = {top:5, bottom:10};
    Chart.defaults.scales.linear.beginAtZero = true; // y axes is forced to include 0    
    Chart.defaults.animation.duration = 0; // don't show graph animations

    // Colors to be used in charts
    const traderColor = 'rgb(75, 192, 192, 0.6)' 
    const secondColor = 'rgb(0, 153, 255, 0.6)'
    const thirdColor = 'rgb(255, 153, 0, 0.6)'

    function responsive_aspectRatio(){
        // Set x-axis height relative to y-axis
        if (window.innerWidth < 600) {
            return 1.3
        }
        else{
            return 2
        }
    }
    function reponsive_display_y_axis_title(){
        // Only show y-axis legend on big enough screens
        if (window.innerWidth < 1000) {
            return false
        }
        else{
            return true
        }
    }

    function format_amount_labels(value, index, values){
        // Default format of 5000 on axis is 5,000. 
        // Here we change this to 5000.00
        return prettify(value);
    }

    // Balance chart 
    var traderBalanceDataSet = {
        label: "Your balance",
        data: JSON.parse("{{ trader_balance_json }}"),
        lineTension: 0,
        borderColor: traderColor,
    };

    var averageBalanceDataSet = {
        label: "{% translate 'Market average balance' %}",
        data: JSON.parse("{{ avg_balance_json }}"),
        lineTension: 0,
        borderColor: thirdColor,
    };
    
    balance_labels = JSON.parse("{{ round_labels_json }}") // labels on x-axis
    {% if not market.endless %}
        balance_labels.unshift("Start")
    {% endif %}
    
    var lineChart = new Chart(document.getElementById('balanceCanvas'), {
            type: 'line',
            data: {
                labels: balance_labels,
                datasets: [traderBalanceDataSet, averageBalanceDataSet]
            },
            options:{
                aspectRatio: responsive_aspectRatio(),
                scales: {
                    y: {
                        title:{ 
                            text: 'Balance (kr.)',
                            display: reponsive_display_y_axis_title()
                        },
                        ticks: {
                            callback: format_amount_labels
                        },
                        suggestedMax: parseInt("{{ market.initial_balance }}"),
                    },
                    x: {
                        title:{ 
                            text: 'Round',
                            display: 'true'
                        }
                    },            
                },  
                plugins: {
                    title: {
                        display: true,
                        text: "{% translate 'Balance' %}",
                    }
                }, 
                 
            }
        }     
    ); 


    // Price chart
    var dataYourPrice = {
        label: "{% translate 'Your price' %}",
        data: JSON.parse("{{ data_price_json }}"),
        lineTension: 0,
        borderColor: traderColor,
    };

    var dataMarketAvgPrice = {
        label: "{% translate 'Market average price' %}",
        data: JSON.parse("{{ data_market_avg_price_json }}"),
        borderColor: secondColor,
    };

    var dataProdCost = {
        label: "{% translate 'Your unit cost' %}",
        data: JSON.parse("{{ data_prod_cost_json }}"),
        borderColor: thirdColor,
    };

    var lineChart = new Chart(priceCanvas = document.getElementById('priceCanvas'),{
        type: 'line',
        data: {
            labels: JSON.parse("{{ round_labels_json }}"), // labels on x-axis
            datasets: [dataYourPrice, dataMarketAvgPrice, dataProdCost]
        },
        options: {
            aspectRatio: responsive_aspectRatio(),
            scales: {
                y: {
                    title:{ 
                        text: 'Cost and price (kr.)',
                        display: reponsive_display_y_axis_title()
                    },
                    ticks: {
                        callback: format_amount_labels
                    },
                    suggestedMax: 2*parseInt("{{ market.max_cost }}"),
                },
                x: {
                    title:{ 
                        text: 'Round',
                        display: 'true'
                    }
                },         
            },  
            plugins: {
                title: {
                    display: true,
                    text: "{% translate 'Price history' %}",
                },
            }
        }
    });

    // Units chart 
    var dataDemand = {
        label: "{% translate 'Demand' %}",
        data: JSON.parse("{{ data_demand_json }}"),
        lineTension: 0,
        borderColor: traderColor,
    };

    var dataSold = {
        label: "{% translate 'Sold' %}",
        data: JSON.parse("{{ data_sold_json }}"),
        borderColor: secondColor,
    };

    var dataProduced = {
        label: "{% translate 'Produced' %}",
        data: JSON.parse("{{ data_produced_json }}"),
        borderColor: thirdColor,
    };

    var lineChart = new Chart(document.getElementById('unitsCanvas'), {
        type: 'line',
        data: {
            labels: JSON.parse("{{ round_labels_json }}"), // labels on x-axis
            datasets: [dataDemand, dataSold, dataProduced] 
        },
        options: {
            aspectRatio: responsive_aspectRatio(),
            scales: {
                y: {
                    title:{ 
                        text: 'Number of units',
                        display: reponsive_display_y_axis_title()
                    },    
                    suggestedMax: 100,
                },
                x: {
                    title:{
                        text: 'Round',
                        display: 'true'
                    }
                },         
            },  
            plugins: {
                title: {
                    display: true,
                    text: "{% translate 'Your production history' %}",
                },
            },
        }
    });
                
</script>

 {% if trader.auto_play and not wait and not market.game_over%}
    <script>
        runit(submit=true)
    </script>
{% endif %}

  
{% endblock javascript%}
